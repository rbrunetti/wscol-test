/*
 * generated by Xtext
 */
package org.xtext.example.xpt.generator;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.util.EObjectContainmentEList;
import org.eclipse.xtext.util.CancelIndicator;
import org.eclipse.xtext.validation.CheckMode;
import org.eclipse.xtext.validation.IResourceValidator;
import org.eclipse.xtext.validation.Issue;
import org.xtext.example.xpt.generator.dataobject.DataObject;
import org.xtext.example.xpt.xpt.Assertion;
import org.xtext.example.xpt.xpt.AssertionForm;
import org.xtext.example.xpt.xpt.AssertionSet;
import org.xtext.example.xpt.xpt.Declaration;
import org.xtext.example.xpt.xpt.Model;

import com.google.inject.Inject;
import com.google.inject.Injector;
import com.google.inject.Provider;

public class Main {

	@Inject
	private Provider<ResourceSet> resourceSetProvider;

	@Inject
	private IResourceValidator validator;

	private static String queriesPath = "/home/ricky/Documenti/Code/XText/Workspace/org.xtext.example.xpt/src/org/xtext/example/xpt/queries.xpt";
	private static String xmlFilePath = "/home/ricky/Documenti/Code/XText/Workspace/org.xtext.example.xpt/src/org/xtext/example/xpt/book.xml";
	@SuppressWarnings("unused")
	private static String xmlFilePath2 = "/home/ricky/Documenti/Code/XText/Workspace/org.xtext.example.xpt/src/org/xtext/example/xpt/book2.xml";

	private static Map<String, Object> variables = new HashMap<>();
	private static DataObject input = new DataObject();

	public static void main(String[] args) {
		Injector injector = new org.xtext.example.xpt.XptStandaloneSetupGenerated().createInjectorAndDoEMFRegistration();
		Main main = injector.getInstance(Main.class);

		File f = new File(queriesPath);
		String string = f.toURI().toString();

		main.runGenerator(string);
	}

	@SuppressWarnings("unused")
	private DataObject hashMapTest() {
		DataObject data = new DataObject();
		DataObject books = new DataObject();
		DataObject book1 = new DataObject();
		DataObject book2 = new DataObject();

		book1.put("title", "Snow Crash");
		book1.put("year", (double)2000);
		book1.put("author", "Neal Stephenson");
		book1.put("publisher", "Spectra");
		book1.put("isbn", "0553380958");
		book1.put("price", (double)15.0);		
		books.put("book", book1);

		book2.put("title", "Burning Tower");
		book2.put("year", (double)2005);
		book2.put("author", "Larry Niven");
		book2.put("author", "Jerry Pournelle");
		book2.put("publisher", "Pocket");
		book2.put("isbn", "0743416910");
		book2.put("price", (double)5.99);
		books.put("book", book2);
		
		books.put("book", (double)5);

		data.put("inventory", books);
		
		return data;

	}

	protected void runGenerator(String string) {
		// load the resource
		ResourceSet set = resourceSetProvider.get();
		Resource resource = set.getResource(URI.createURI(string), true);

		// validate the resource
		List<Issue> list = validator.validate(resource, CheckMode.ALL, CancelIndicator.NullImpl);
		if (!list.isEmpty()) {
			System.err.println("*** MALFORMED ASSERTIONS ***");
			for (Issue issue : list) {
				System.err.println(issue);
			}
			return;
		}

		// get contents
		Model model = (Model) resource.getContents().get(0);
		EObjectContainmentEList<Declaration> declarations = (EObjectContainmentEList<Declaration>) model.getDeclarations();
		AssertionSet assertionSet = model.getQuerySet();
		
		// get input: via xml parsing or passed DataObject
		input = new DataObject(xmlFilePath);
//		input = hashMapTest();

		if (assertionSet.eContents().isEmpty()) {
			System.out.println("No assertions. Execution halted.");
			return;
		}

		 System.out.println(declarations.size() + " variable declarated.");
		 System.out.println(assertionSet.getAssertions().size() + " assertions has been found.");
		 System.out.println();
		
		 // get variables declaration and sets the hashmap
		 setVariable(declarations);
		
		 // verify the assertions
		 verifyAssertions(assertionSet);

	}

	/**
	 * Check all the assertions
	 * 
	 * @param assertionSet
	 */
	private void verifyAssertions(AssertionSet assertionSet) {
		System.out.println();
		System.out.println("################ ASSERTIONS ################");
		Object laObj, raObj;
		String op, condition;
		for (AssertionForm af : assertionSet.getAssertions()) {
			laObj = doQueries(af.getLeftAssert());
			raObj = doQueries(af.getRightAssert());
			op = af.getOp(); // get Op for using it for the comparisons
			condition = Helper.assertionFormToString(af);

			// if the assertion's query has a numeric result
			if (laObj instanceof Double && raObj instanceof Double) {
				double la = (Double) laObj;
				double ra = (Double) raObj;
				switch (op) {
				case ">":
					if (la > ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}
					break;
				case ">=":
					if (la >= ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}
					break;
				case "<":
					if (la < ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}

					break;
				case "<=":
					if (la <= ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}
					break;
				case "=":
					if (la == ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}

					break;
				case "!=":
					if (la != ra) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}
					break;
				}
			} else if (laObj instanceof String && raObj instanceof String) {
				switch (op) {
				case "=":
					if (laObj.equals(raObj)) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}

					break;
				case "!=":
					if (!laObj.equals(raObj)) {
						System.out.println("Assertion '" + condition + "' is verified.");
					} else {
						System.out.println("Assertion '" + condition + "' is wrong.");
					}
					break;
				}
			} else if(laObj != null && raObj != null) {
				System.err.println("Assertion '" + condition + "' malformed: data types conflict.");
				return;
			} else {
				System.err.println("Unable to evaluate assertion '" + condition + "', due to erroneous variables declaration.");
			}
		}
	}

	/**
	 * Print the result of the evaluation of queries
	 */
	private Object doQueries(Assertion assertion) {
		Object result = new Object();
		// if the assertion is a constant it's not going to be an xpath query
		if (assertion.getConstant() != null) {
			result = ((assertion.getConstant().getString() == null) ? assertion.getConstant().getInt() : assertion.getConstant().getString());
			return result;
		}
		// TODO sto trattando un solo valore! Non considera variabili multivalore
		
		// look if there's a placeholder, if any substitute it with its values (note: the placeholder is always on the first step!)
		if(assertion.getQuery().getSteps().get(0).getPlaceholder() != null){
			if(!variables.containsKey(assertion.getQuery().getSteps().get(0).getPlaceholder())){ // TODO da valutare come trattare (dichiarazioni sbagliate -> variabile assente)
				return null;
			}
			Object value = variables.get(assertion.getQuery().getSteps().get(0).getPlaceholder());
			try {
				if(assertion.getQuery().getSteps().size() > 1) { // if there query goes deeper
					result = ((DataObject)value).evaluate(assertion.getQuery()).getFirst();
				} else {
					result = ((DataObject) value).getFirst();
				}
			} catch (ClassCastException e){
				result = value;
			}
		} else {
			result = input.evaluate(assertion.getQuery());
			result = ((DataObject)result).getFirst();
		}
		
		//*** FUNCTIONS ***
		if (assertion.getFunction() != null) {
			switch (assertion.getFunction()) {
			case "uppercase":
				result = ((String) result).toUpperCase();
				break;
			case "length":
				result = (double) ((String) result).length();
				break;
			default:
				break;
			}
		}
		return result;
	}

	/**
	 * Set variables according to the declarations
	 */
	private void setVariable(EObjectContainmentEList<Declaration> declarations) {
		System.out.println();
		System.out.println("############### DECLARATIONS ###############");
		for (Declaration d : declarations) {
			if (d.getAssert().getConstant() != null) {
				variables.put(d.getVar(), d.getAssert().getConstant());
			} else {
				DataObject result = input.evaluate(d.getAssert().getQuery());
				//TODO come trattare il fatto di avere un risultato?
				// if the assertion is wrong (with respect to the input variable) or empty the program is halted
				if(result == null){
					System.err.println("Unable to evaluate '" + d.getVar() + " = " + Helper.assertionToString(d.getAssert()) + "'. Please check it.");
					System.exit(0);
				} else {
					variables.put(d.getVar(), result);
				}
			}
			System.out.println(d.getVar() + " = " + Helper.assertionToString(d.getAssert()));
		}
		return;
	}

}